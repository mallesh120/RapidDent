# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# RapidDent â€“ Fastlane Configuration
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

default_platform(:ios)

PROJECT    = "RapidDent.xcodeproj"
SCHEME     = "RapidDent"
BUNDLE_ID  = "com.manya.RapidDent"
TEAM_ID    = "U8B97NVD7G"
OUTPUT_DIR = "./build"

platform :ios do

  # â”€â”€ Build â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  desc "Build the app (debug, no code-sign)"
  lane :build do
    xcodebuild(
      project: PROJECT,
      scheme: SCHEME,
      configuration: "Debug",
      destination: "generic/platform=iOS Simulator",
      build: true,
      clean: true,
      xcargs: "CODE_SIGNING_ALLOWED=NO"
    )
    UI.success("âœ… Debug build succeeded")
  end

  desc "Build for release (archive-ready)"
  lane :build_release do
    gym(
      project: PROJECT,
      scheme: SCHEME,
      configuration: "Release",
      sdk: "iphoneos",
      clean: true,
      output_directory: OUTPUT_DIR,
      output_name: "RapidDent.ipa",
      export_method: "development",
      skip_codesigning: false
    )
    UI.success("âœ… Release build succeeded â†’ #{OUTPUT_DIR}/RapidDent.ipa")
  end

  # â”€â”€ Test â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  desc "Run unit tests"
  lane :test do
    scan(
      project: PROJECT,
      scheme: SCHEME,
      devices: ["iPhone 16"],
      clean: true,
      code_coverage: true,
      output_directory: "#{OUTPUT_DIR}/test_results"
    )
    UI.success("âœ… Tests passed")
  end

  desc "Run UI tests"
  lane :ui_test do
    scan(
      project: PROJECT,
      scheme: SCHEME,
      devices: ["iPhone 16"],
      clean: true,
      only_testing: ["RapidDentUITests"],
      output_directory: "#{OUTPUT_DIR}/ui_test_results"
    )
    UI.success("âœ… UI tests passed")
  end

  # â”€â”€ Lint / Analyze â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  desc "Static analysis with xcodebuild analyze"
  lane :analyze do
    xcodebuild(
      project: PROJECT,
      scheme: SCHEME,
      configuration: "Debug",
      destination: "generic/platform=iOS Simulator",
      analyze: true,
      xcargs: "CODE_SIGNING_ALLOWED=NO"
    )
    UI.success("âœ… Analyze passed â€“ no warnings")
  end

  # â”€â”€ TestFlight Beta â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  desc "Build & upload to TestFlight"
  lane :beta do
    build_number = Time.now.strftime("%Y%m%d%H%M")

    gym(
      project: PROJECT,
      scheme: SCHEME,
      configuration: "Release",
      clean: true,
      output_directory: OUTPUT_DIR,
      output_name: "RapidDent.ipa",
      export_method: "app-store",
      destination: "generic/platform=iOS",
      xcargs: "CURRENT_PROJECT_VERSION=#{build_number}"
    )

    upload_to_testflight(
      skip_waiting_for_build_processing: true
    )

    UI.success("ğŸš€ Uploaded to TestFlight (build #{build_number})")
  end

  # â”€â”€ App Store Release â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  desc "Build & submit to App Store for review"
  lane :release do
    build_number = Time.now.strftime("%Y%m%d%H%M")

    gym(
      project: PROJECT,
      scheme: SCHEME,
      configuration: "Release",
      sdk: "iphoneos",
      clean: true,
      output_directory: OUTPUT_DIR,
      output_name: "RapidDent.ipa",
      export_method: "app-store",
      xcargs: "CURRENT_PROJECT_VERSION=#{build_number}"
    )

    upload_to_app_store(
      force: true,
      skip_screenshots: true,
      skip_metadata: true
    )

    UI.success("ğŸ‰ Submitted to App Store review (build #{build_number})")
  end

  # â”€â”€ Convenience â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  desc "Clean derived data"
  lane :clean do
    clear_derived_data
    UI.success("ğŸ§¹ Derived data cleared")
  end

  desc "Full CI pipeline: clean â†’ build â†’ test"
  lane :ci do
    clean
    build
    test
    UI.success("ğŸ CI pipeline complete")
  end

end
